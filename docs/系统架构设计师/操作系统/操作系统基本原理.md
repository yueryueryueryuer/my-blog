# 操作系统基本原理

操作系统的主要功能是进行处理机与进程管理、存储管理、设备管理、文件管理和作业管理的工作

## 进程管理

进程（process）是资源分配和独立运行的基本单位。
研究操作系统的进程，实质上是研究系统中诸进程的并发特性和相互制约性。

### 进程的定义及分类

进程的**定义**：

是程序的一次执行，该程序可以和其他程序并发执行。

进程通常由**程序、数据、进程控制块**（Process Control Block，PCB）组成。PCB 描述了进程的基本情况，是进程存在的**唯一标识**。

进程按照**性质不同分类**：

- 系统进程和用户进程
- 父进程和子进程

### 进程的状态转换与控制

进程的**状态**：

- 就绪
- 运行
- 阻塞

<img :src="$withBase('/img/系统架构设计师/操作系统/进程三态模型.png')"/>

<img :src="$withBase('/img/系统架构设计师/操作系统/进程五态模型.png')"/>

### 进程的互斥与同步及 P、V 操作

进程的**同步**：

异步环境下各进程按照一定的顺序和速度执行。

进程的**互斥**：

临界资源在某一个时刻只能被一个进程访问。

临界资源的**定义**：

系统中资源一次只能供一个进程使用，被称为临界资源，如打印机、磁带机、输入机等。

临界区的**定义**：

进程中对临界资源进行操作的那段程序。

临界区的**管理原则**：

1. 有空即进：无进程处于临界区时，若有进程要求进入则立即允许其进入
2. 无空则等：有进程处于临界区时，若有进程要求进入必须让其等待，保证进程互斥的进入临界区
3. 有限等待：对要求访问临界资源的进程，应保证在有限时间内能进入临界区，避免“死等”
4. 让权等待：对于等待进入临界区的进程，必须释放其占有的 CPU

信号量：

是一个整型变量，根据控制对象的不同赋不同的值。

- 公用信号量：实现进程的互斥，初值=1 或资源的数目
- 私有信号量：实现进程的同步，初值=0 或某个正整数

信号量 S 的**物理意义**：

- S >= 0，某资源的可用数
- S < 0，其绝对值表示阻塞队列中等待该资源的进程数

对信号量只能施加特殊的操作：P 操作和 V 操作。P 操作和 V 操作是不可分割的原子操作，也成为原语。

- P 操作代表申请一个资源
- V 操作代表释放一个资源

**P 操作的定义**：

S = S - 1 ，若 S >= 0，则执行 P 操作的进程继续执行，若 S < 0，则执行 P 操作的进程进入阻塞状态，并将其插入进阻塞队列。

**V 操作的定义**：

S = S + 1 ，若 S > 0，则执行 V 操作的进程继续执行，若 S <= 0，则从阻塞队列中唤醒一个进程，并将其插入就绪队列，并执行 V 操作的进程继续执行。

利用 **P、V 操作实现进程的互斥**：

令信号量 mutex 的初值为 1，进临界区时执行 P 操作，退出临界区时执行 V 操作

```bash
P (mutex)
临界区
V (mutex)
```

### 进程通信与管程

**进程通信**：

通信是指进程间的信息交换

- 控制信息的交换：低级通信，进程的同步和互斥是通过信息量来实现通信的，属于低级信息
- 数据的交换：高级通信，高级通信有共享存储系统和信息传递系统和管道通信。高级通信方式有直接通信和简介通信

**管程**：

一种同步机制，管程是由一些共享数据、一组能为并发进程执行的作用在共享数据上的操作的集合、初始代码以及存取权组成的，也即共享数据在其上操作的一组过程就构成了管程。进程可在任何需要资源的时候调用管程，且在任何时刻最多只有一个进程能真正进入管程。

### 进程调度

进程调度即处理器调度（又称上下文转换），**主要功能**是确定处理器在什么时候分配个哪一个进程

**引起进程调度的原因**：

1. 正在执行的进程执行完毕
2. 执行中的进程自己调用阻塞原语将自己阻塞起来进入睡眠状态
3. 执行中的进程调用了 P 原语操作，从而因资源不足而阻塞，或调用了 V 原语操作，唤醒了等待资源的进程队列
4. 在分时系统中，当一个进程用完了时间片
5. 就绪队列中某进程的优先级变得高于当前执行中进程的优先级

**调度方式**：

当优先级更高的进程到来时如何分配 CPU。

- 可剥夺：当就绪队列中有进程优先级高于当前执行的进程优先级时，立即发生进程调度，转让处理器
- 不可剥夺：一旦一个进程占用了处理器，别的进程就不能剥夺处理器，直到该进程因自己调用原语操作而进入阻塞状态，或时间片用完让出处理器

**调度算法**:

- 先来先服务（First Come And First Serverd,FCFS）：又称先进先出服务（First In And First Out,FIFO），按照就绪队列先来后到排列
- 时间片轮转（Round Robin）：就绪队列按 FCFS 排列，每个进程执行一次占用的处理器时间不得超过时间片，若超过，自行释放占用的处理器并排在就绪队列最后，等待下一次调度
- 优先级调度：就绪队列按优先级排列，有两种确定优先级的方法，静态优先级和动态优先级，静态优先级在进程执行前确定，执行过程中不变；动态优先级则可以在进程执行过程中改变
- 多级反馈调度：按优先级分多个队列，每个队列中按照 FCFS 分配时间片调度，当前队列时间片用完后还未完成则进入下一列队，当有优先级更高的进程到来时，当前正在运行的进程放到当前队列的队尾，处理机分给高优先级的进程

### 死锁

死锁的**概念**：

两个及以上的进程因为互相请求对方已占用的资源，无限期的等待并无法继续运行下去的现象

死锁、饥饿、死循环的**区别**：

- 死锁：至少两个进程才能发生死锁，死锁进程处于阻塞状态
- 饥饿：资源分配不同导致某些进程在不发生死锁的情况下长期等待，当等待时间给进程推进和相应带来明显影响时，被称为进程饥饿，饥饿进程可能阻塞也可能就绪
- 死循环：可能只有一个进程进入死循环，死循环的进程可以上处理机

> 死锁和饥饿是操作系统要解决的问题，死循环是程序员要解决的问题

死锁产生的**四个必要条件**：

1. 互斥条件：对必须互斥使用的资源争夺才可能发生死锁
2. 不剥夺条件：进程保持的资源只能主动释放，不能强行剥夺
3. 请求和保持条件：保持某些资源不释放的同时，请求别的资源
4. 循环等待条件：存在一种进程资源的循环等待链，循环等待不一定死锁，死锁一定循环等待

死锁产生的**原因**：

对不可剥夺资源的不合理分配

死锁的**处理策略**：

1. 预防死锁：破坏死锁产生的四个必要条件
2. 避免死锁：避免系统进入不安全状态，例如先执行银行家算法。精心分配资源。
3. 死锁发生后的检测和解除：允许死锁发生，系统负责检出死锁并解除

> 系统出现死锁几率很小，死锁发生后的检测和解除比避免死锁的代价要小

### 线程

线程是进程中的一个实体，是被系统独立分配和调度的基本单位。同一个进程中的所有线程共享该进程中的所有资源，同一个进程中的线程可并发执行，线程也有就绪、运行、阻塞三个状态

## 存储管理

存储器是计算机系统的关键资源，是存放各种信息的主要场所。存储器的发展方式是高速、大容量、小体积。存储管理的主要任务是提高主存的利用率、扩充主存以及对主存信息实现有效保护。存储管理的对象是主存储器。

**存储器结构**：

- 寄存器——主存——外存
- 寄存器——缓存——主存——外存

<img :src="$withBase('/img/系统架构设计师/计算机与网络基础知识/存储器的层次结构.png')"/>

**术语**：

- 逻辑地址（相对地址、程序地址、虚拟地址）：用户程序经编译后，每个目标模块以 0 为基地址进行顺序编址，它不是主存中的真实地址，是相对于基地址而言的
- 物理地址（绝对地址）：主存中各存储单元的地址，从统一的基地址进行顺序编址，是主存中的真实地址，可以寻址并实际存在
- 存储空间：逻辑地址空间（地址空间）是逻辑地址的集合，物理地址空间（存储空间）是物理地址的集合

**地址重定位**：

程序的逻辑地址被转换为主存的物理地址的过程被称为地址重定位。

地址重定位有两种方式。

- 静态重定位：在程序执行之前重定位，即装入内存时重定位
- 动态重定位：在程序执行期间，每次存储访问之前重定位

**功能**：

主存储器的分配和回收、提高主存储器的利用率、存储保护、主存扩容

**方式**：

分区存储管理、分页存储管理、分段存储管理、段页式存储管理、虚拟存储管理。

## 设备管理

在计算机系统中，输入/输出（I/O）设备、辅存设备、终端设备等被称为外部设备，它们是计算机系统与外界交互的工具，负责计算机与外部的输入输出工作。

设备管理的**任务**：

保证在多道程序环境下，多个进程竞争使用设备时，按一定政策分配和管理各种设备，控制设备的各项操作，完成输入/输出设备和主存之间的数据交换

设备管理的**目标**：

提高设备利用率，为用户提供方便统一的界面

设备管理的**主要功能**：

动态的掌握并记录设备的状态、设备分配和释放、缓冲区管理、实现物理输入/输出设备的操作、提供设备使用的用户接口、设备访问和控制、输入/输出缓冲和调度

设备的**分类**：

- 按设备使用特性：存储设备、输入/输出设备、终端设备、脱机设备
- 按资源分配角度：独占设备、共享设备、虚拟设备
- 按设备从属关系：系统设备、用户设备
- 按数据组织方式：块设备（Block Device）、字符设备（Character Device）
- 按数据传输速率：低速设备、中速设备、高速设备
- 按输入/输出设备：人机通信设备、机机通信设备
- 按是否可交互：非交互设备、交互设备

设备管理**主要技术**：

- 中断技术：使 CPU 中止正在执行的程序而转去处理特殊事件的操作
- DMA 技术（Direct Memory Access，直接存储器访问）：允许不同速度的硬件装置来沟通，不需要依赖 CPU 大量中断负载
- 缓冲技术：协调吞吐速度相差很大的设备之间数据传送而采用的技术
- 虚设备与 SPOOLING 技术（simultaneous peripheral operations online，外围设备联机技术）：低速输入/输出设备与主机交换的一种技术

设备管理**软件**：

- 中断处理程序
- 设备驱动程序
- 与设备无关的系统软件
- 用户层 I/O 软件

**数据传输控制方式**：

- 程序控制方式：处理器启动数据传输，然后等设备完成
- 中断方式：数据传输完成后，设备控制器产生中断请求
- 直接存储访问方式（DMA）：外部设备和内存之间开辟的直接数据交换通路
- 通道方式：通道又称为输入/输出处理器(Input/Output Processor，IOP)，通过自身输入/输出专用程序进行内存和外设之间的数据传输。主要有三种传输通道：
  1. 字节多路通道
  2. 选择通道
  3. 成组多路通道

**磁盘调度算法**：

磁盘是可供多个进程共享的设备。磁盘调度使各进程对磁盘的平均访问时间最小。

常用的磁盘调度算法：

- 先来先服务（First Come Fisrt Serverd，FCFS）
- 最短寻道时间优先（Shortest Seek Time First，SSTF）
- 扫描算法（SCAN）

## 文件管理

文件是具有符号名的、在逻辑上具有完整意义的一组相关信息项的集合。文件名的格式和长度因系统而异，操作系统根据文件名对其进行控制和管理。

文件管理系统是操作系统中对文件进行统一管理的一组软件和相关数据的集合，简称文件系统。

文件系统的功能按名存取、统一用户接口、并发访问和控制、安全性控制、优化性能、差错恢复。

### 文件类型

- 按文件性质能用途：系统文件、库文件、用户文件
- 按文件的安全属性：只读文件、读写文件、可执行文件、不保护文件
- 按文件的组织形式：普通文件、目录文件、设备文件
- 按信息保存的期限：临时文件、档案文件、永久文件
- 按信息流向：输入文件、输出文件、输入/输出文件

### 文件的结构和组织

文件的结构是文件的组织形式。从用户角度看到的文件组织形式称为文件的逻辑结构，从实现角度看到的文件在存储设备上的存放方式，称为文件的物理结构。

- 文件的逻辑结构
  - 有结构的记录文件
  - 无结构的字节流文件
- 文件的物理结构
  - 连续结构
  - 链接结构
  - 索引结构
  - 多个物理块的索引表

### 文件的访问方法

文件的访问方法是指读写文件存储设备上的一个物理块的方法。

常用的**访问方法**：

- 顺序访问：对文件中的信息按顺序依次读写
- 随机访问：对文件中的信息可以按任意次序随机的读写
